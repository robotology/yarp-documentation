<!-- HTML header for doxygen 1.8.12-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>YARP: Handling NVIDIA GPUs with YARP</title>
<link rel="shortcut icon" href="yarp-favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = { VERSION: '3.1.2' };
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="yarp-doxygen-style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../version_switch.js"></script>
<link rel="stylesheet" type="text/css" href="cookieconsent.min.css" />
<script src="cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#eb6c44",
      "text": "#ffffff"
    },
    "button": {
      "background": "#237afc",
    }
  },
  "theme": "classic",
  "content": {
    "message": "INFORMATION NOTICE ON COOKIES : This website uses only browsing/session cookies. Users can choose whether or not to accept the use of cookies and access the website. By clicking on \"Further information\", the full information notice on the types of cookies will be displayed and you will be able  to choose whether or not to accept them whilst browsing on the website.",
    "dismiss": "ACCEPT and close",
    "link": "Further information",
    "href": "http://www.icub.org/other/personal_data_notice.html"
  }
})});
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="yarp-robot-64.png"/></td>
  <td id="projectalign" style="padding-left: 1.5em;">
   <div id="projectname">YARP</div>
   <div id="projectbrief">Yet Another Robot Platform</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('gpu_tutorial.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Handling NVIDIA GPUs with YARP </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Author</dt><dd>Giacomo Spigler</dd></dl>
<h1><a class="anchor" id="gpu_tutorial_introduction"></a>
Introduction</h1>
<p>In the last years graphics cards became more and more powerful, and eventually they reached computing speeds of the order of hundreds of gigaflops. Graphics Processing Units, or GPUs are dedicated processors, cheap enough to be affordable by everyone and powerful enough to be able to replace clusters of tens of modern computers. YARP has now two new modules, which come with the main distribution (starting from the latest releases): CUDA and NVIDIA. This documentation only regards CUDA, even thought it is compatible only with the latest Nvidia chipsets. The other driver is slower and worse optimized. These new modules rely on the new IGPUInterface class, which can be easily found into libYARP_dev's includes.</p>
<h1><a class="anchor" id="gpu_tutorial_yarpcode"></a>
Example: YARP application</h1>
<p>Programming with the CUDA module is quite easy, but there are some requirements. Let's start with an example. The full code of this example can be found under the example/cuda directory. First of all, make sure to include the following headers into your application: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="GPUInterface_8h.html">yarp/dev/GPUInterface.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="PolyDriver_8h.html">yarp/dev/PolyDriver.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="Drivers_8h.html">yarp/dev/Drivers.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceyarp_1_1dev.html">yarp::dev</a>;</div>
</div><!-- fragment --><p>Then you can proceed creating an instance to the driver's object: </p><div class="fragment"><div class="line">Property config;</div>
<div class="line"><span class="comment">// no arguments, use a default</span></div>
<div class="line"><span class="keywordtype">char</span> str[80];</div>
<div class="line">sprintf(str, <span class="stringliteral">&quot;(device cuda) (w %d) (h %d) (bpp 3)&quot;</span>, img.width(), img.height());</div>
<div class="line">config.fromString(str);</div>
<div class="line"> </div>
<div class="line">PolyDriver dd(config);</div>
<div class="line"><span class="keywordflow">if</span> (!dd.isValid()) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Failed to create and configure a device\n&quot;</span>);</div>
<div class="line">    exit(1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">IGPUDevice *gpu;</div>
<div class="line"><span class="keywordflow">if</span> (!dd.view(gpu)) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;Failed to view device through IGPUDevice interface\n&quot;</span>);</div>
<div class="line">    exit(1);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="gpu_tutorial_cubin"></a>
Example: GPU program</h1>
<p>Now you have a working CUDA driver set up and configured. However, to start using it, you have to load the programs you want to execute on your data. Programs are in cubin format, which is a kind of ascii executable and that the GPU can understand. We will see later on how to compile custom programs. To load them, just do: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> prog = gpu-&gt;load(<span class="stringliteral">&quot;progs/bw.cubin&quot;</span>);</div>
</div><!-- fragment --><p>Then you can finally execute it. Processing on data is accomplished either with c arrays of elements or YARP images. There are two overloaded methods CUDA has to handle it, IGPUInterface::execute, which can handle "unsigned char *" or "ImageOf&lt;PixelRgb&gt;". Support for floats might come soon. </p><div class="fragment"><div class="line">gpu-&gt;execute(prog, &amp;img, &amp;out);</div>
</div><!-- fragment --><p>At the end of the program, just put: </p><div class="fragment"><div class="line">dd.close();</div>
</div><!-- fragment --><p>Now you have a YARP application, but you need some programs to run on the GPU. Program's structure has always to be the same (for more information I'd suggest the CUDA programming manual). Following, it is an example program (to convert RGB images to BW): </p><div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> {</div>
<div class="line"> </div>
<div class="line">  __global__ <span class="keywordtype">void</span> FragmentProgram(<span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out) {</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span>(i=threadIdx.x+blockIdx.x; i&lt;w*h; i+=blockDim.x*gridDim.x) {</div>
<div class="line">      out[i*3]=(in[i*3]+in[i*3+1]+in[i*3+2])/3;</div>
<div class="line">      out[i*3+1]=out[i*3];</div>
<div class="line">      out[i*3+2]=out[i*3];</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><p> Let's look at it. Just a quick note, the software automatically defines some objects, namely <code>threadIdx</code>, <code>blockIdx</code>, <code>blockDim</code> and <code>gridDim</code>. At the moment, for ease of usage, they are just used 1D, accessed as <code>threadIdx.x</code>. The first one is the id of the thread which executes the main function (within its current block); the second one is the id of the block within the block grid. <code>blockDim</code> is the numbe of threads contained in a single block, and <code>gridDim</code> is the size of the block grid.</p>
<p>Then, the main function (at the moment just use the main function) has to be named FragmentProgram, and to have a "__global__" before its type. Type is not important, so you might always set it to void. The FragmentProgram function will run on every GPU's core, executing the same instructions (SIMD approach), but every thread will have its own threadIdx.x identifier. At last we have to compile the GPU program into the binary <code>.cubin</code> object: </p><div class="fragment"><div class="line">nvcc -cubin bw.cu</div>
</div><!-- fragment --><p>Using this information, and knowing the number of threads currently running, you can write parallel code to run on the GPU, analyzing input data and generating outputs. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="aDrivers_8h_html"><div class="ttname"><a href="Drivers_8h.html">Drivers.h</a></div></div>
<div class="ttc" id="anamespaceyarp_1_1dev_html"><div class="ttname"><a href="namespaceyarp_1_1dev.html">yarp::dev</a></div><div class="ttdoc">An interface for the device drivers.</div><div class="ttdef"><b>Definition:</b> <a href="AudioGrabberInterfaces_8h_source.html#l00018">AudioGrabberInterfaces.h:18</a></div></div>
<div class="ttc" id="aPolyDriver_8h_html"><div class="ttname"><a href="PolyDriver_8h.html">PolyDriver.h</a></div></div>
<div class="ttc" id="aGPUInterface_8h_html"><div class="ttname"><a href="GPUInterface_8h.html">GPUInterface.h</a></div><div class="ttdoc">define interfaces for a generic GPU</div></div>
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li><span id="projectname_footer">YARP</span></li>
    <li><span id="projectnumber" class="version_switch">3.1.2</span></li>
    <li class="footer">Generated on Tue Nov 3 2020 16:43:15 for YARP by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
