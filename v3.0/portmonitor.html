<!-- HTML header for doxygen 1.8.12-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>YARP: Port monitoring and arbitration using the portmonitor carrier</title>
<link rel="shortcut icon" href="yarp-favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = { VERSION: '3.0.1' };
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="yarp-doxygen-style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../version_switch.js"></script>
<link rel="stylesheet" type="text/css" href="cookieconsent.min.css" />
<script src="cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#eb6c44",
      "text": "#ffffff"
    },
    "button": {
      "background": "#237afc",
    }
  },
  "theme": "classic",
  "content": {
    "message": "INFORMATION NOTICE ON COOKIES : This website uses only browsing/session cookies. Users can choose whether or not to accept the use of cookies and access the website. By clicking on \"Further information\", the full information notice on the types of cookies will be displayed and you will be able  to choose whether or not to accept them whilst browsing on the website.",
    "dismiss": "ACCEPT and close",
    "link": "Further information",
    "href": "http://www.icub.org/other/personal_data_notice.html"
  }
})});
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="yarp-robot-64.png"/></td>
  <td id="projectalign" style="padding-left: 1.5em;">
   <div id="projectname">YARP</div>
   <div id="projectbrief">Yet Another Robot Platform</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('portmonitor.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Port monitoring and arbitration using the portmonitor carrier </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><dl class="section author"><dt>Author</dt><dd>Ali Paikan</dd></dl>
<h1><a class="anchor" id="content"></a>
Contents</h1>
<ul>
<li><a class="el" href="portmonitor.html#what_is">What is the portmonitor carrier?</a> </li>
<li><a class="el" href="portmonitor.html#which_is">Which functionalities are we talking about?</a> </li>
<li><a class="el" href="portmonitor.html#need">What do I need to use portmonitor carrier?</a> </li>
<li><a class="el" href="portmonitor.html#use">How can I use port monitor?</a> </li>
<li><a class="el" href="portmonitor.html#callbacks">Portmonitor life cycle and API</a> </li>
<li><a class="el" href="portmonitor.html#portarbitrator">Port Arbitration</a> </li>
<li><a class="el" href="portmonitor.html#portmonitor_exmp">Examples and tutorials</a> </li>
<li><a class="el" href="portmonitor.html#reading">Further reading</a></li>
</ul>
<p><br  />
 </p>
<h1><a class="anchor" id="what_is"></a>
What is the portmonitor carrier?</h1>
<p>In short, it is an extended functionality of a port implemented as a new carrier which allows to dynamically load at runâ€“time script (or dynamically linked libraries such as .so/.dll) and plug it into the port of an existing module without changing the code or recompiling it. Using run-time scripts (currently written in Lua) or DLLs we can access and modify the data traveling through the port using a simple API. In this way extra functionalities of a component can be added during application development time and without the need to modify and rebuild the component itself.</p>
<p><br  />
 </p>
<h1><a class="anchor" id="which_is"></a>
Which functionalities are we talking about?</h1>
<ul>
<li>Data Guarding and Filtering</li>
<li>Data Transformation</li>
<li>Logging and Performance Monitoring</li>
<li>Monitoring communication for Quality of Service</li>
</ul>
<div class="image">
<img src="portmonitor.png" alt=""/>
<div class="caption">
An example of port monitor. The output port of FaceDetector modules is extended with a plug-in which provides access to the outgoing data through scripting language (e.g., Lua)</div></div>
<p><br  />
 </p>
<h1><a class="anchor" id="need"></a>
What do I need to use portmonitor carrier?</h1>
<ul>
<li>Enable portmonitor carrier (ENABLE_yarpcar_portmonitor_carrier=ON) in CMake and compile YARP.</li>
</ul>
<ul>
<li>To be able to use plug-ins written in LUA with the portmonitor carrier you need to compile yarp-lua binding and set the 'LUA_CPATH' to find yarp-lua binding library (see <a class="el" href="yarp_swig.html">Using YARP from python, java, ruby, C#, and other languages</a>).</li>
</ul>
<ul>
<li>For using compiled plug-ins (.dll/.so) with the portmonitor carrier you only need to put them in system path where commonly DLLs can be found. For example in the Linux machines you can set the &lsquo;LD_LIBRARY_PATH&rsquo; to point the folder where you compiled the DLL.</li>
</ul>
<p><br  />
 </p>
<h1><a class="anchor" id="use"></a>
How can I use port monitor?</h1>
<p>You should connect two ports using the YARP 'portmonitor' carrier modifier and explicitly tells the carrier which type of plug-in you are using (lua or dll):</p>
<pre class="fragment">  $ yarp connect /out /in tcp+recv.portmonitor+type.lua+context.myapp+file.my_lua_script
</pre><p>This rather weird syntax can be read as follow. Connect port /out to /in using the tcp transport protocol. Chain the receiver (recv) side of the port /in to the plugin portmonitor with parameters: type=lua, context=myapp and file=my_lua_script ('.' here can be indeed interpreted as an assignment operator).</p>
<p>This connects '/out' to '/in' using tcp and a portmonitor carrier modifier on the receiver side. Alternatively the script can be plugged into the sender port:</p>
<pre class="fragment">  $ yarp connect /out /in tcp+send.portmonitor+type.lua+context.myapp+file.my_lua_script
</pre><p>or a DLL can be loaded instead of the Lua script:</p>
<pre class="fragment">  $ yarp connect /out /in tcp+send.portmonitor+type.dll+file.my_dll_file
</pre><ul>
<li>'recv.portmonitor' or 'send.portmonitor' indicates that a portmonitor carrier modiffier should be used respectively in receiver or sender side.</li>
<li>'type.lua' or 'type.dll' respectively tells the carrier to expect Lua script or a DLL file.</li>
<li>'context.myapp' is only used for the scripts and it tells the resource finder to load the script from the 'myapp' context. If context is not used, the current path where module is launched will be searched for the script file.</li>
<li>'file.my_lua_script' indicates 'my_lua_script' (alternatively my_dll_file) should be loaded by monitor object. For the scripts, the 'my_lua_script' is located using standard Yarp Resource Finder policy. The postfix (e.g., '.lua') is not necessary. The DLLs should be located in the system standard path, the same folder the program is running or the paths indicated in &lsquo;LD_LIBRARY_PATH&rsquo; on the Linux machines.</li>
</ul>
<p><br  />
 </p>
<h1><a class="anchor" id="callbacks"></a>
Portmonitor life cycle and API</h1>
<div class="image">
<img src="portmonitor_lifecycle.png" alt=""/>
<div class="caption">
The life cycle of port monitor.</div></div>
<p>A callback function is assigned to each state (except Waiting) which can have a corresponding implementation in the userâ€™s script. Using these callbacks, users have full control over the portâ€™s data and can access it, modify it and decide whether to accept the data or discard it. The Port Monitor starts in the Create state in which &lsquo;PortMonitor.create&rsquo; callback is called. The initialization of the userâ€™s code can be done at this point. Returning a true value means that the userâ€™s initialization was successful and the monitor object is able to start monitoring data from the port. When data arrives to the monitor, &lsquo;PortMonitor.accept&rsquo; is called and an instance of Yarp &lsquo;Things&rsquo; object is passed to the callback function. In this callback, user can access (for reading purposes only) the data, check it and decide whether to accept or discard it. The return value of this function indicates whether the data should be delivered (accepted) or discarded. If the data is accepted, &lsquo;PortMonitor.update&rsquo; is called, at which point the user has access to modify the data.</p>
<ul>
<li><b>PortMonitor.create</b> : This is called when the script is loaded and the port monitor object is created (i.e. when the ports are connected). Returning 'false' will avoid calling other functions and stop the monitor object. The 'options' parameter is of type yarp.Property object (consists of a set of properties/values) provides some information about the current connection which the PortMonitor object is attached. For example "sender_side" or "receiver_side" keys in the options list respectively indicates whether the port monitor object is attached to the sender side or the receiver side of the connection. They can be accessed as &lsquo;options:find("sender_side"):asBool()&rsquo;</li>
</ul>
<pre class="fragment">    PortMonitor.create = function(options)
        ...
        return true     --default
    end
</pre><ul>
<li><b>PortMonitor.destroy</b>: This is called when the monitor object is destroying (e.g., on disconnect)</li>
</ul>
<pre class="fragment">    PortMonitor.destroy = function()
        ...
    end
</pre><ul>
<li><b>PortMonitor.accept</b> : This is called when a new data arrives to the port. User can access the data and check whether it should accept or discard it. Returning 'false' will discard delivering data to the port and avoids calling PortMonitor.update().</li>
</ul>
<pre class="fragment">    PortMonitor.accept = function(thing)
        ...
        return true     --default
    end
</pre><ul>
<li><b>PortMonitor.update</b> : This will be called if the data is accepted by PortMonitor.update(). User can modify and return it using &lsquo;Thing&rsquo; object.</li>
</ul>
<pre class="fragment">PortMonitor.update = function(thing)
    ...
    return thing
end
</pre><ul>
<li><b>PortMonitor.update_reply</b> : When a portmonitor object attached to an RPC port (two-way connection), this will be called upon receiving the reply. User can modify and return the replied message using &lsquo;Thing&rsquo; object. PortMonitor.update() and PortMonitor.update_reply() together allows the user to access the outgoing message and incoming reply within a RPC port. Notice that in the current implementation, this feature is only available if the portmonitor is attached to a sender port (RPC Client). <br  />
</li>
</ul>
<pre class="fragment">PortMonitor.update_reply = function(thing)
    ...
    return thing
end
</pre><ul>
<li><b>PortMonitor.setparam/getparam</b> : This will be called by the YARP port administrator when users try to reconfigure the monitor object using YARP port administrative commands (See <a class="el" href="image_modification.html">An example of image data modification and setting parameters via administrative port</a>). The 'param' is of type yarp.Property object.</li>
</ul>
<pre class="fragment">PortMonitor.setparam = function(param)
    ...
end

PortMonitor.getparam = function()
    ...
    return param
end
</pre><ul>
<li><b>PortMonitor.trig</b> : By default, this will be called when one of the peer connections to the same input port receives data. The peer-trigging is not available if the portmonitor is plugged into the sender port. A port monitor will usually act as a passive object in which PortMonitor.accept() and PortMonitor.update() callbacks are executed in sequence as data arrives. However, one may need to periodically monitor a connection (within a specific time interval) and, for example, generates proper events in case of delay in the communication. For this purpose, a portmonitor object can be configured to call PortMonitor.trig() within desired time intervals using PortMonitor.setTrigInterval().</li>
</ul>
<pre class="fragment">PortMonitor.trig = function()
    ...
end
</pre><dl class="section note"><dt>Note</dt><dd>Port monitor carrier looks for the global table name 'PortMonitor' in the user script and calls its corresponding functions if exist. Notice that the PortMonitor is a global variable and should not be altered or assigned to nil.</dd>
<dd>
Here we only described the callbacks in Lua scripting language. Indeed the same callbacks are also available in C++ for implementing plug-ins as DLLs. Please refer to <a class="el" href="simple_dll.html">An example which shows how to use C++ and DLLS to modify incoming data in an input port</a> for the details.</dd></dl>
<p><br  />
 </p>
<h1><a class="anchor" id="portarbitrator"></a>
Port Arbitration</h1>
<p>A port arbitrator is an extended functionality of an input port which can be configured to arbitrate data from multiple source based on some userâ€“defined constraints.</p>
<div class="image">
<img src="portarbitrator.png" alt=""/>
<div class="caption">
An example of using port arbitrator (left) and the architecture of port arbitrator (right). Straight lines show the data flow and zigzag lines represent event flows</div></div>
<p>A port arbitrator consists of multiple port monitors, a set of selection constraints, an event container and a selector block. Port arbitrator extends the port's scripting API for setting constraints and altering events in the container. In fact, when a port monitor is used in an arbitrator, the user's script can access the extended API for arbitration.</p>
<p>A port monitor can be attached to each connection (Ci) going through the port arbitrator. It monitors the data from connection and inserts the corresponding events into a shared container. A port monitor can also remove an event (if previously inserted by itself) from the container. Normally events have infinite life time. This means that they remain valid in the container until they are explicitly removed by the monitor object. An event can also have a specific life time. A time event will be automatically removed from the container when its life time is over. For each connection Ci , there is a selection constraint written in first order logic as a boolean combination of the symbolic events. Upon the reception of data from a connection, the selector evaluates the corresponding constraint and, if satisfied, it allows the data to be delivered to the input port; otherwise the data will be discarded.</p>
<p>Beside the port monitor callbacks, there is a set of auxiliary functions which is offered by the PortMonitor. These auxiliary functions are used for the port arbitration (See <a class="el" href="arbitration.html">An example of using port monitors for arbitrating multiple connections</a>).</p>
<ul>
<li><b>PortMonitor.setEvent(event, lifetime)</b> : set an event (with optional lifetime) into port event record</li>
<li><b>PortMonitor.unsetEvent(event)</b> : unset an event into port event record</li>
<li><b>PortMonitor.setConstraint(rule)</b> : set the selection rule</li>
<li><b>PortMonitor.getConstraint()</b> : get the selection rule</li>
</ul>
<p><br  />
 </p>
<h1><a class="anchor" id="portmonitor_exmp"></a>
Examples and tutorials</h1>
<ul>
<li><a class="el" href="simple_modification.html">Simple data filtering and modification</a></li>
<li><a class="el" href="type_modification.html">Simple data type modification</a></li>
<li><a class="el" href="image_modification.html">An example of image data modification and setting parameters via administrative port</a></li>
<li><a class="el" href="arbitration.html">An example of using port monitors for arbitrating multiple connections</a></li>
<li><a class="el" href="arbitration_tevent.html">An example of using port arbitrator with time events</a></li>
<li><a class="el" href="simple_dll.html">Simple data filtering and modification using DLL and C++</a></li>
<li><a class="el" href="coder_decoder.html">Using the portmonitor object at the both sides of a connection to encode and decode data</a></li>
</ul>
<p><br  />
 </p>
<h1><a class="anchor" id="reading"></a>
Further reading</h1>
<ul>
<li>[1] Data Flow Port's Monitoring and Arbitration, Paikan, A., Fitzpatrick, P., Metta, G., and Natale, L., Journal of Software Engneering for Robotics, vol. 5, no. 1, pp. 80-88, 2014. [<a href="http://joser.unibg.it/index.php?journal=joser&amp;page=article&amp;op=view&amp;path%5B%5D=72">pdf</a>]</li>
</ul>
<ul>
<li>[2] Enhancing software module reusability using port plug-ins: an experiment with the iCub robot, Paikan, A., Tikhanoff, V., Metta, G., and Natale, L., International Conference on Intelligent Robots and Systems (IROS 2014). [<a href="http://arxiv.org/pdf/1411.1102v1.pdf">pdf</a>] </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li><span id="projectname_footer">YARP</span></li>
    <li><span id="projectnumber" class="version_switch">3.0.1</span></li>
    <li class="footer">Generated on Tue Nov 3 2020 16:37:07 for YARP by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
