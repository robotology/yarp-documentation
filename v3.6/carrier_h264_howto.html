<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>YARP: h264 carrier</title>
<link rel="shortcut icon" href="yarp-favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = { VERSION: '3.6.0' };
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="yarp-doxygen-style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../version_switch.js"></script>
<link rel="stylesheet" type="text/css" href="cookieconsent.min.css" />
<script src="cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#eb6c44",
      "text": "#ffffff"
    },
    "button": {
      "background": "#237afc",
    }
  },
  "theme": "classic",
  "content": {
    "message": "INFORMATION NOTICE ON COOKIES : This website uses only browsing/session cookies. Users can choose whether or not to accept the use of cookies and access the website. By clicking on \"Further information\", the full information notice on the types of cookies will be displayed and you will be able  to choose whether or not to accept them whilst browsing on the website.",
    "dismiss": "ACCEPT and close",
    "link": "Further information",
    "href": "http://www.icub.org/other/personal_data_notice.html"
  }
})});
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="yarp-robot-64.png"/></td>
  <td id="projectalign" style="padding-left: 1.5em;">
   <div id="projectname">YARP</div>
   <div id="projectbrief">Yet Another Robot Platform</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('carrier_h264_howto.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">h264 carrier </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#gstreamer_introduction">Gstreamer: brief introduction</a></li>
<li class="level1"><a href="#how_to_stream_h264">How to stream in h264</a><ul><li class="level2"><a href="#server_side">Server side:</a></li>
<li class="level2"><a href="#client_side">Client side</a></li>
<li class="level2"><a href="#some_options">Some options</a></li>
</ul>
</li>
<li class="level1"><a href="#how_to_install_gstreamer">How to install Gstreamer</a><ul><li class="level2"><a href="#ubuntu">On Ubuntu</a></li>
<li class="level2"><a href="#windows">On windows</a></li>
<li class="level2"><a href="#check_installation">Verify your installation</a><ul><li class="level3"><a href="#server">Server side (example on Windows)</a></li>
<li class="level3"><a href="#client">Client side</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#notes">Notes</a><ul><li class="level2"><a href="#tricks">Tricks</a></li>
</ul>
</li>
<li class="level1"><a href="#references">References</a></li>
</ul>
</div>
<div class="textblock"><p>If your robot has cameras with high resolution, you need to compress and to stream their images.</p>
<p>In order to achieve this, we use Gstreamer, a free framework for media applications.</p>
<p>This document contains a brief introduction to Gstreamer tool and explains how the high-resolution cameras stream is encoding and how a yarp application can read it.</p>
<dl class="section note"><dt>Note</dt><dd>They are still work in progress and should be considered experimental. Please report any problems.</dd></dl>
<h1><a class="anchor" id="gstreamer_introduction"></a>
Gstreamer: brief introduction</h1>
<p>Gstreamer is a free framework for media applications; it provides a set of plugins that let the user to build applications by connecting them as in a pipeline. It has been ported to a wide range of operating systems, processors and compilers. Also Nvidia developed plugins for its platforms and we employ its h264 encode in order to take advantage from its hardware codec.</p>
<p>A Gstreamer application is composed by a chain of elements, the base construction block of a Gstreamer application. An element takes an input stream from previous element in the chain, carries out its function, like encode, and passes the modified stream to the next element. Usually each element is a plugin.</p>
<p>The user can develop application in two way: the first consists in write an application in c/c++, where the elements are connected using API, while the second uses the gst-launch command-line tool. In the following an example of how to use gst-launch command:</p>
<pre class="fragment">gst-launch-1.0 -v videotestsrc ! ‘video/x-raw, format=(string)I420, width=(int)640, height=(int)480’ ! x264enc ! h264parse ! avdec_h264 ! autovideosink </pre><p>This command creates a source video test with the properties specified in this string <em> “video/x-raw, format=(string)I420, width=(int)640, height=(int)480”</em>; after it is encoded in h264, then decoded and shown. Each element of this pipeline, except the property element, is plugins dynamically loaded. The videotestsrc element lets the user to see a stream without using camera.</p>
<p>The previous command works on Linux, but since Gstreamer is platform independent, we can launch the same command on Windows taking care to change only hardware dependent plugin. So the same command on Window is:</p>
<pre class="fragment">gst-launch-1.0 -v videotestsrc ! “video/x-raw, format=(string)I420, width=(int)640, height=(int)480” !
                openh264enc ! h264parse ! avdec_h264 ! autovideosink
</pre><p>It’s important to notice that the changed element is the encoder (openh264enc), while the decoder is the same. This because the decoder belongs to the plugin that wraps libav library, a cross-platform library to convert stream in a wide range of multimedia formats. [see <a class="el" href="carrier_h264_howto.html#references">References</a> chapter]</p>
<p><em> Please see <a class="el" href="carrier_h264_howto.html#notes">Notes</a> section about commands in this tutorial. </em></p>
<h1><a class="anchor" id="how_to_stream_h264"></a>
How to stream in h264</h1>
<p>The server grabs images from cameras, so it needs to run on where cameras are connected. The server is a Gstreamer command pipeline, while the client could be a yarp or a Gstreamer application connected to the robot’s network.</p>
<p>Since Gstreamer is wide spread framework for media application, wrap it into yarp it is not interesting and is worthless. Instead is more intriguing that a yarp application can read “standard” streams using the h264 carrier. For these reasons, the server streamer is a native Gstreamer pipeline, while the client side has been developed in yarp like a carrier.</p>
<h2><a class="anchor" id="server_side"></a>
Server side:</h2>
<p>The server application consists in the following Gstreamer command:</p>
<pre class="fragment">gst-launch-1.0 -v v4l2src device="/dev/video1" ! ‘video/x-raw, width=1280, height=480, format=(string)I420’ !
                omxh264enc ! h264parse ! rtph264pay pt=96 config-interval=5 ! udpsink host=224.0.0.1 auto-multicast=true  port=33000
</pre><ul>
<li><em>v4l2src device="/dev/video1"</em>: reads the cameras using v4l (video for linux) driver </li>
<li><em>‘video/x-raw, width=640, height=480, format=(string)I420’ </em>: this is a property-element that specifies image size and format. In order to know which sizes and format are available you can use “v4l2-ctl” utility. </li>
<li><em>omxh264enc</em>: encodes in h264: plugin developed by Nvidia </li>
<li><em>h264parse</em>: signals downstream the format of the stream </li>
<li><em>rtph264pay</em>: puts h264 stream in rtp packets </li>
<li><em>udpsink</em>: this is the last element and sends out the stream. In this case we use multicast, but it is possible to send the stream using unicast in this way: udpsink host=IP_ADDRESS_OF_CLIENT port=NOT_WELL_KNOWN_PORT_NUMBER</li>
</ul>
<p>Currently is not available a Gstreamer application that implements the pipeline. In the near future, it could be developed in order to make easier configure the server.</p>
<h2><a class="anchor" id="client_side"></a>
Client side</h2>
<p>The client can read the stream using Gstreamer native command or yarp.</p>
<p>In the first case the Gstreamer command is: </p><pre class="fragment">gst-launch-1.0 -v udpsrc multicast-group=224.0.0.1 auto-multicast=true port=3000 caps="application/x-rtp, media=(string)video, encoding-name=(string)H264, payload=(int)96" !
                rtph264depay ! h264parse ! avdec_h264! autovideosink
</pre><p>If you want use a yarp application to read the stream you need to: </p><pre class="fragment">1)  install Gstreamer (see \ref how_to_install_gstreamer )
2)  compile yarp with “ENABLE_yarpcar_h264” option enabled.
3)  register the stream server to the yarp server: “yarp name register &lt;SERVER_NAME_PORT&gt;  h264  &lt;SERVER_IP_ADRESS&gt; &lt;SERVER_IP_PORT&gt;”
4)  run your application
5)  connect client and server port using h264 carrier: “yarp connect &lt;SERVER_NAME_PORT&gt; &lt;CLIENT_PORT&gt; h264”
</pre><h2><a class="anchor" id="some_options"></a>
Some options</h2>
<ul>
<li><b>set the frame rate </b>: in server side exist the parameter framerate=30/1, that configures the framerate to which grab images. Insert in in property element: 'video/x-raw, format=(string)I420, width=(int)640, height=(int)480, framerate=30/1' </li>
<li>In some cases could be useful that server streams video at <b>constant rate</b>. You can achieve this adding this parameter to the encoder plugin: control-rate=2 bitrate=5000000 </li>
<li><b>remove the jitter</b>: in the client it is possible adding the rtpjitterbuffer plugin in this way: If you want to remove the jitter in h264 yarp carrier, please add parameter “+removeJitter.1” in connect command. (Note that the syntax is the usual used to specify parameters to yarp carriers). Therefore the connect command to your application could be: <pre class="fragment">    yarp connect &lt;SERVER_NAME_PORT&gt; &lt;CLIENT_PORT&gt; h264+removeJitter.1</pre> </li>
<li>The yarp carrier lets you to <b>crop</b> each frame specifying the number of pixel to crop on each side of image in carrier parameter in connection command. For example if you want to crop 200 pixel on top the command appears like: \verbatimyarp connect &lt;SERVER_NAME_PORT&gt; &lt;CLIENT_PORT&gt; h264+cropTop.200. Instead, if you want to use native Gstreamer client the plugin “videocrop” performs this operation. <pre class="fragment">    gst-launch-1.0 -v udpsrc port=33000 caps="application/x-rtp, media=(string)video,  encoding-name=(string)H264, payload=(int)96" !
                    rtph264depay ! h264parse ! avdec_h264 ! videocrop left=10, right=30, top=50, bottom=50 ! autovideosink</pre></li>
</ul>
<h1><a class="anchor" id="how_to_install_gstreamer"></a>
How to install Gstreamer</h1>
<p>Currently we are using 1.8.3 version</p>
<h2><a class="anchor" id="ubuntu"></a>
On Ubuntu</h2>
<ul>
<li>Packages required to build<ul>
<li>libgstreamer1.0-dev</li>
<li>libgstreamer-plugins-base1.0-dev </li>
</ul>
</li>
<li>Packages required to run<ul>
<li>gstreamer1.0-plugins-base (for videoconvert and appsink)</li>
<li>gstreamer1.0-plugins-good (for udpsrc and rtph264depay)</li>
<li>gstreamer1.0-plugins-bad (for h264parse)</li>
<li>gstreamer1.0-libav (for avdec_h264) </li>
</ul>
</li>
<li>Useful packages but not required<ul>
<li>gstreamer1.0-tools</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="windows"></a>
On windows</h2>
<p>You need to download both the main package and the devel package from here: <a href="https://gstreamer.freedesktop.org/data/pkg/windows/">https://gstreamer.freedesktop.org/data/pkg/windows/</a></p>
<p>Installation of package Gstreamer: </p><ul>
<li>choose typical installation </li>
<li>redo installation adding:<ul>
<li>Gstreamer 1.0 devtools</li>
<li>Gstreamer 1.0 Libav wrapper</li>
</ul>
</li>
</ul>
<p>Installation of grstreamer devel package: </p><ul>
<li>choose typical installation </li>
<li>redo installation adding:<ul>
<li>Gstreamer 1.0 devtools</li>
<li>Gstreamer 1.0 Libav wrapper </li>
</ul>
</li>
<li>Add in path environment variable the path to executable (Usually is C:\gstreamer\1.0\x86_64\bin)</li>
</ul>
<h2><a class="anchor" id="check_installation"></a>
Verify your installation</h2>
<p>First of all, you need to verify if Gstreamer has been installed successfully by using these commands:</p>
<h3><a class="anchor" id="server"></a>
Server side (example on Windows)</h3>
<pre class="fragment">gst-launch-1.0 -v videotestsrc ! "video/x-raw, format=(string)I420, width=(int)640, height=(int)480" !
                openh264enc ! h264parse ! rtph264pay pt=96 config-interval=5 ! udpsink host=&lt;YOUR_IP_ADDRESS&gt; port=&lt;A_PORT_NUMBER&gt;
</pre><h3><a class="anchor" id="client"></a>
Client side</h3>
<pre class="fragment">gst-launch-1.0 -v udpsrc port=&lt;A_PORT_NUMBER&gt; caps="application/x-rtp, media=(string)video, encoding-name=(string)H264, payload=(int)96" !
                rtph264depay ! h264parse ! avdec_h264! autovideosink
</pre><p>After you can substitute the client side with a yarp application, for example yarpview. So, after yarp server had been launched, please run:</p>
<ul>
<li>yarpview </li>
<li>yarp name register /gst h264 &lt;YOUR_IP_ADDRESS&gt; &lt;A_PORT_NUMBER&gt; </li>
<li>yarp connect /gst /yarpview/img:i h264</li>
</ul>
<p>Now on yarp view you can see the following image, where in the bottom right box there is snow pattern.</p>
<div class="image">
<img src="h264GstVideoTestSrc.png" alt=""/>
</div>
<h1><a class="anchor" id="notes"></a>
Notes</h1>
<h2><a class="anchor" id="tricks"></a>
Tricks</h2>
<ul>
<li>On Ubuntu 18.04 the plugin “autovideosink” has a bug, please use “xvimagesink” </li>
<li>On Windows the property element uses ‘ instead of “</li>
</ul>
<h1><a class="anchor" id="references"></a>
References</h1>
<p>[1] Gstreamer documentation <a href="https://gstreamer.freedesktop.org/documentation/">https://gstreamer.freedesktop.org/documentation/</a></p>
<p>[2] Gstreamer plugins <a href="https://gstreamer.freedesktop.org/documentation/plugins.html">https://gstreamer.freedesktop.org/documentation/plugins.html</a></p>
<p>[3] Libav library documentation <a href="https://www.libav.org/index.html">https://www.libav.org/index.html</a></p>
<p>[4] Gstreamer Libav plugin <a href="https://gstreamer.freedesktop.org/modules/gst-libav.html">https://gstreamer.freedesktop.org/modules/gst-libav.html</a></p>
<p>[5] h264 yarp plugin <a href="http://www.yarp.it/classyarp_1_1os_1_1H264Carrier.html">http://www.yarp.it/classyarp_1_1os_1_1H264Carrier.html</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li><span id="projectname_footer">YARP</span></li>
    <li><span id="projectnumber" class="version_switch">3.6.0</span></li>
    <li class="footer">Generated on Wed Jun 1 2022 14:48:31 for YARP by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
