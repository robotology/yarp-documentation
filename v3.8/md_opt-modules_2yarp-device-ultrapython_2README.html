<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>YARP: 1. ULTRAPYTHON CAMERA SYSTEM</title>
<link rel="shortcut icon" href="yarp-favicon.ico" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = { VERSION: '3.8.1' };
</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="yarp-doxygen-style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../version_switch.js"></script>
<script src="https://cookiehub.net/c2/44d56061.js"></script>
<script type="text/javascript">
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('consent', 'default', {'ad_storage': 'denied', 'analytics_storage': 'denied', 'wait_for_update': 500});
document.addEventListener("DOMContentLoaded", function(event) {
var cpm = {};
window.cookiehub.load(cpm);
});
</script>
<!--
<link rel="stylesheet" type="text/css" href="cookieconsent.min.css" />
<script src="cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#eb6c44",
      "text": "#ffffff"
    },
    "button": {
      "background": "#237afc",
    }
  },
  "theme": "classic",
  "content": {
    "message": "INFORMATION NOTICE ON COOKIES : This website uses only browsing/session cookies. Users can choose whether or not to accept the use of cookies and access the website. By clicking on \"Further information\", the full information notice on the types of cookies will be displayed and you will be able  to choose whether or not to accept them whilst browsing on the website.",
    "dismiss": "ACCEPT and close",
    "link": "Further information",
    "href": "http://www.icub.eu/other/personal_data_notice.html"
  }
})});
</script>
-->
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="yarp-robot-64.png"/></td>
  <td id="projectalign" style="padding-left: 1.5em;">
   <div id="projectname">YARP</div>
   <div id="projectbrief">Yet Another Robot Platform</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_opt-modules_2yarp-device-ultrapython_2README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">1. ULTRAPYTHON CAMERA SYSTEM</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1064"></a> The UltraPython camera system is composed by:</p>
<ul>
<li>Enclustra carrier</li>
<li>Xilinx board module</li>
<li>Cameras board</li>
<li>Two sensors and optics</li>
</ul>
<p>The board has, as output, an image that merges the images from the two sensors.</p>
<p><img src="img/merge001.png" alt="" width="300px" class="inline"/> <br  />
<br  />
</p>
<h1><a class="anchor" id="autotoc_md1065"></a>
1.1. Naming</h1>
<p>The folowing name convention is used:</p>
<ul>
<li>Local Linux PC = <b>iCub-head</b></li>
<li>Enclustra board carrier, with Xilinx module,cameras board and sensors = <b>Enclustra</b></li>
</ul>
<h1><a class="anchor" id="autotoc_md1066"></a>
1.2. MOUNTING</h1>
<p>Mount the cameras board and Xilinx board as in the figure:</p>
<p><img src="img/mountedboard.jpg" alt="" width="300px" class="inline"/> <br  />
<br  />
</p>
<p>The jumpers should be set as in the figure.</p>
<p><img src="img/jp.jpg" alt="" width="150px" class="inline"/> <br  />
<br  />
</p>
<p>The deep switches should be set as in the figure.</p>
<p><img src="img/dip.jpg" alt="" width="300px" class="inline"/> <br  />
<br  />
</p>
<p>Use the correct Ethernet port.</p>
<p><img src="img/eth.jpg" alt="" width="300px" class="inline"/></p>
<p>Power and switch-on button:</p>
<p><img src="img/power.jpg" alt="" width="300px" class="inline"/></p>
<p>Fan:</p>
<p><img src="img/fan.jpg" alt="" width="300px" class="inline"/></p>
<p>Led after a few seconds from power on :</p>
<p><img src="img/led.jpg" alt="" width="300px" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md1067"></a>
1.3. Experimental setup</h1>
<p>An experimental setup is availabe. <br  />
 <img src="img/setup.jpg" alt="" width="300px" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md1068"></a>
1.4. ACCESS</h1>
<h2><a class="anchor" id="autotoc_md1069"></a>
1.4.1. IP address</h2>
<p>:exclamation:<u>To be done on iCub-head.</u></p>
<p>Add to iCub-head the wired address 10.0.1.104 <br  />
<br  />
 Select <code>wired connected -&gt; wired settings</code> from menu:</p>
<p><img src="img/net000.png" alt="" width="300px" class="inline"/> <br  />
<br  />
</p>
<p>Add pc104 connection:</p>
<p><img src="img/address003.png" alt="" width="300px" class="inline"/> <br  />
<br  />
</p>
<p>Add correct params:</p>
<p><img src="img/address004.png" alt="" width="300px" class="inline"/></p>
<p>Final addressing map: <br  />
 <b>Enclustra board</b> address: 10.0.1.233 <br  />
 <b>iCub-head pc address</b>: 10.0.1.104</p>
<h1><a class="anchor" id="autotoc_md1070"></a>
1.5. SERIAL ACCESS</h1>
<p>:exclamation:<u>To be done on iCub-head.</u></p>
<p>Connect iCub-head to the Enclustra board via micro-USB and execute:</p>
<div class="fragment"><div class="line">screen /dev/ttyUSB1 115200</div>
</div><!-- fragment --><p>Login as root, no password.</p>
<p><img src="img/USB.jpg" alt="" width="300px" class="inline"/> <br  />
 <br  />
<br  />
<br  />
</p>
<p>:warning:<em>Troubleshooting</em> <br  />
 In this case, a different serial port is to be used:</p>
<div class="fragment"><div class="line">screen /dev/ttyUSB0 115200</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1071"></a>
1.6. GIVE INTERNET ACCESS to Enlustra via Shorewall</h1>
<p>:exclamation:<u>To be done on iCub-head.</u></p>
<p>Check and modify in <code>shorewall/interfaces</code></p>
<ul>
<li>internet access netcard (ZONE=net) with your internet card</li>
<li>local access netcard (ZONE=lan) with your LAN net card</li>
</ul>
<p>For check netcard names <code>ifconfig</code></p>
<p>Do the same in <code>shorewall/masq</code> &lt;internet card&gt;&lt;lan card&gt;</p>
<p>Then</p>
<div class="fragment"><div class="line">sudo apt-get install shorewall</div>
<div class="line">sudo cp shorewall/* /etc/shorewall</div>
<div class="line">sudo service shorewall start</div>
</div><!-- fragment --><p>Test from Enclustra <code>ping 8.8.8.8</code></p>
<p>Current net configuration: <br  />
 <img src="img/net001.png" alt="" width="500px" class="inline"/></p>
<p>:warning:<em>Troubleshooting</em></p>
<ul>
<li>Check if the Enclustra is running and is connected</li>
</ul>
<h1><a class="anchor" id="autotoc_md1072"></a>
2. yarpdev for the UltraPython camera</h1>
<p>On iCubHead Yarp should be installed, on Enclustra Yarp+UltraPython device should be installed.</p>
<p>This section describes how to execute yarpdev for the UltraPython camera. <br  />
 :exclamation: On iCubHead</p>
<div class="fragment"><div class="line">yarpserver --write</div>
</div><!-- fragment --><p>:exclamation: On running Enclustra <b>only the very first time</b>:</p>
<div class="fragment"><div class="line">yarp conf 10.0.1.104 10000</div>
</div><!-- fragment --><p>:exclamation: On running Enclustra</p>
<p>Low definition stream:</p>
<div class="fragment"><div class="line">cd ~/icubtech/yarp-device-ultrapython/ini</div>
<div class="line">yarpdev --from lowultra.ini</div>
</div><!-- fragment --><p>High definition stream:</p>
<div class="fragment"><div class="line">cd ~/icubtech/yarp-device-ultrapython/ini</div>
<div class="line">yarpdev --from hiultra.ini</div>
</div><!-- fragment --><p>:exclamation: On iCubHead</p>
<div class="fragment"><div class="line">ultrapythonui --remote /grabber&amp;</div>
<div class="line">yarpview&amp;</div>
<div class="line">yarp connect /grabber /yarpview/img:i</div>
</div><!-- fragment --><p>Or you can execute the script::</p>
<div class="fragment"><div class="line">. &lt;path&gt;/yarp-device-ultrapython/script-video.sh</div>
</div><!-- fragment --><p>:warning:<em>Troubleshooting</em></p>
<p>If yarpdev exits and return errors, check if kernel modules for the UltraPython are loaded.</p>
<div class="fragment"><div class="line">lsmod</div>
</div><!-- fragment --><p>If nothing is shown load modules:</p>
<div class="fragment"><div class="line">cd /root/icubtech/yarp-device-ultrapython/ubuntu-files/yarp.local</div>
<div class="line">./preliminary.sh</div>
</div><!-- fragment --><p>By default, modules should be loaded on startup.</p>
<h2><a class="anchor" id="autotoc_md1073"></a>
2.1. Ultrapython UI</h2>
<p>The UI for UltraPython is called <code>ultrapythonui</code> and is self-explaining.<br  />
 <br  />
 <img src="img/UI001.png" alt="" width="500px" class="inline"/> <br  />
 The syntax for execute is:</p>
<div class="fragment"><div class="line">ultrapythonui --remote /name</div>
</div><!-- fragment --><p><b>NOTE</b>: <br  />
 the name is without rpc and the port name usually is /grabber. For name look at .ini file <b>name</b> field.</p>
<p><code>frameGrabberGui2</code> is not the right choice for the UltraPyhton camera system.</p>
<h2><a class="anchor" id="autotoc_md1074"></a>
2.2. WIP - UltraPython Command Line Interface</h2>
<p>The user can access the camera controls on the terminal through a command line application called <code>ultrapythoncli</code>.</p>
<p>To set a camera feature, use</p>
<div class="fragment"><div class="line">ultrapythoncli --remote /name --set &lt;YARP code&gt;=&lt;value&gt;</div>
</div><!-- fragment --><p>where the YARP code for the desired feature is defined in Section 3.6, and the target value is expressed in absolute units.</p>
<p>Similarly, to get the current value of a desired feature in absolute units, use</p>
<div class="fragment"><div class="line">ultrapythoncli --remote /name  --get &lt;YARP code&gt;</div>
</div><!-- fragment --><p><b>NOTE</b>: <br  />
 Like the GUI, the port name usually is /grabber. For name look at .ini file <b>name</b> field.</p>
<h2><a class="anchor" id="autotoc_md1075"></a>
2.3. The .ini files</h2>
<p>The .ini files for the UltraPython are in:</p>
<div class="fragment"><div class="line">cd ~/icubtech/yarp-device-ultrapython/ini</div>
</div><!-- fragment --><p>The ini files for lowres</p>
<div class="fragment"><div class="line">device grabberDual</div>
<div class="line">subdevice ultrapython</div>
<div class="line">period 80</div>
<div class="line">name /grabber</div>
<div class="line">honorfps false</div>
</div><!-- fragment --><p>The ini files for hires</p>
<div class="fragment"><div class="line">device grabberDual</div>
<div class="line">subdevice ultrapython</div>
<div class="line">period 28</div>
<div class="line">name /grabber</div>
<div class="line">subsampling</div>
<div class="line">honorfps false</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1076"></a>
2.4. Reading the log on console</h2>
<p>At run-time the log will be like this repeated:</p>
<div class="fragment"><div class="line">[INFO] |yarp.dev.Drivers| device active in background...</div>
<div class="line">[DEBUG] |yarp.device.UltraPython| not remapped feature: 70</div>
<div class="line">[DEBUG] |yarp.device.UltraPython| getControl feature: 70  value: 16.8</div>
<div class="line">[INFO] |yarp.device.UltraPythonStatistics| frames read by YARP  frame number: 84  fps: 16.8  interval: 5.03997  sec.  exposition: 0  msec.</div>
</div><!-- fragment --><p>Every 5 seconds a statistic is issued with current FPS.</p>
<h1><a class="anchor" id="autotoc_md1077"></a>
3. UltraPython specifications for yarpdev</h1>
<h2><a class="anchor" id="autotoc_md1078"></a>
3.1. Resolution</h2>
<p>2560x1024 (full) <br  />
 1280x512 (subsampling)</p>
<h2><a class="anchor" id="autotoc_md1079"></a>
3.2. Colour space</h2>
<p>For now, the only choice is RGB.</p>
<h2><a class="anchor" id="autotoc_md1080"></a>
3.3. Kernel modules</h2>
<p>The following kernel modules should be loaded before starting to work with the UltraPython, order is important:</p>
<div class="fragment"><div class="line">insmod xilinx_frmbuf.ko</div>
<div class="line">insmod v4l2-fwnode.ko</div>
<div class="line">insmod videobuf2-dma-contig.ko</div>
<div class="line">insmod xilinx-vip.ko</div>
<div class="line">insmod xilinx-video.ko is_mplane=0</div>
<div class="line">insmod xilinx-vpss-csc.ko</div>
<div class="line">insmod xilinx-vtc.ko</div>
<div class="line">insmod xilinx-tpg.ko</div>
<div class="line">insmod xilinx-demosaic.ko</div>
<div class="line">insmod xilinx-python1300-rxif.ko dyndbg==p</div>
<div class="line">insmod imgfusion.ko</div>
<div class="line">insmod python1300.ko</div>
</div><!-- fragment --><p>The modules can be loaded vai script but if all goes well they are loaded at boot time.</p>
<h2><a class="anchor" id="autotoc_md1081"></a>
3.4. Device</h2>
<p>Once the modules are loaded the following devices can be used. <code>/root/media0</code> is the root device.</p>
<p>The subdevices: <br  />
 <code>/root/dev/v4l-subdev0</code> <br  />
 <code>/root/dev/v4l-subdev1</code> <br  />
 <code>/root/dev/v4l-subdev2</code> <br  />
 <code>/root/dev/v4l-subdev3</code> <br  />
 <code>/root/dev/v4l-subdev4</code> <br  />
 <code>/root/dev/v4l-subdev5</code> <br  />
 <code>/root/dev/v4l-subdev6</code> <br  />
 <code>/root/dev/v4l-subdev7</code> <br  />
 <code>/root/dev/v4l-subdev8</code></p>
<h2><a class="anchor" id="autotoc_md1082"></a>
3.5. yarpdev parameters for the UltraPython</h2>
<ul>
<li><code>device</code>, Yarp Device to be used --&gt; grabberDual</li>
<li><code>subdevice</code>, Yarp Subdevice to be used --&gt; ultrapython</li>
<li><code>name</code>, local Yarp port name --&gt; /grabber</li>
<li><code>subsampling</code>, enable the subsampling mode. If not specified the subsampling mode is disabled</li>
<li><code>period</code> YARP read period in msec. The period is the</li>
<li><code>capabilities</code> --&gt; COLOR</li>
<li><code>twoCameras</code> --&gt; false</li>
<li><code>honorfps</code> --&gt; false or true if FPS must be constant</li>
</ul>
<h2><a class="anchor" id="autotoc_md1083"></a>
3.6. YARP-V4L feature that can be used together with the UltraPython</h2>
<p>Currently exposed parameters: <br  />
 </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Code   </th><th class="markdownTableHeadNone">YARP Feature   </th><th class="markdownTableHeadNone">Default   </th><th class="markdownTableHeadNone">Min   </th><th class="markdownTableHeadNone">Max   </th><th class="markdownTableHeadNone">Note   </th><th class="markdownTableHeadNone">Read-write    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Gain   </td><td class="markdownTableBodyNone">8   </td><td class="markdownTableBodyNone">YARP_FEATURE_GAIN   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">11   </td><td class="markdownTableBodyNone">mapped to a combination of digital and analog gain of the board   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Exposure<br  />
Shutter   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">YARP_FEATURE_SHUTTER<br  />
YARP_FEATURE_EXPOSURE   </td><td class="markdownTableBodyNone">20ms   </td><td class="markdownTableBodyNone">1ms   </td><td class="markdownTableBodyNone">50ms   </td><td class="markdownTableBodyNone">mapped on <b>tag_l</b>   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Brightness   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">YARP_FEATURE_BRIGHTNESS   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">4055   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Contrast   </td><td class="markdownTableBodyNone">74   </td><td class="markdownTableBodyNone">YARP_FEATURE_CONTRAST   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">100   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Red gain   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">YARP_FEATURE_RED_GAIN   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">99   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Blue gain   </td><td class="markdownTableBodyNone">51   </td><td class="markdownTableBodyNone">YARP_FEATURE_BLUE_GAIN   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">99   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Green gain   </td><td class="markdownTableBodyNone">52   </td><td class="markdownTableBodyNone">YARP_FEATURE_GREEN_GAIN   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">99   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">R/W    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Gain absolute   </td><td class="markdownTableBodyNone">60   </td><td class="markdownTableBodyNone">YARP_FEATURE_GAIN_ABSOLUTE   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">11   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Exposure absolute   </td><td class="markdownTableBodyNone">61   </td><td class="markdownTableBodyNone">YARP_FEATURE_EXPOSURE_ABSOLUTE   </td><td class="markdownTableBodyNone">20ms   </td><td class="markdownTableBodyNone">1ms   </td><td class="markdownTableBodyNone">50ms   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Brightness absolute   </td><td class="markdownTableBodyNone">62   </td><td class="markdownTableBodyNone">YARP_FEATURE_BRIGHTNESS_ABSOLUTE   </td><td class="markdownTableBodyNone">200   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">4055   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Contrast absolute   </td><td class="markdownTableBodyNone">75   </td><td class="markdownTableBodyNone">YARP_FEATURE_CONTRAST_ABSOLUTE   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">100   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Red gain absolute   </td><td class="markdownTableBodyNone">63   </td><td class="markdownTableBodyNone">YARP_FEATURE_RED_GAIN_ABSOLUTE   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">99   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Blue gain absolute   </td><td class="markdownTableBodyNone">64   </td><td class="markdownTableBodyNone">YARP_FEATURE_BLUE_GAIN_ABSOLUTE   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">99   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Green gain bsolute   </td><td class="markdownTableBodyNone">65   </td><td class="markdownTableBodyNone">YARP_FEATURE_GREEN_GAIN_ABSOLUTE   </td><td class="markdownTableBodyNone">50   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">99   </td><td class="markdownTableBodyNone">Only read for now   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Fps   </td><td class="markdownTableBodyNone">70   </td><td class="markdownTableBodyNone">YARP_FEATURE_FPS   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Subsampling   </td><td class="markdownTableBodyNone">72   </td><td class="markdownTableBodyNone">YARP_FEATURE_SUBSAMPLING   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Not yet implemented<br  />
set only via config file   </td><td class="markdownTableBodyNone">R    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Honor fps   </td><td class="markdownTableBodyNone">73   </td><td class="markdownTableBodyNone">YARP_FEATURE_HONOR_FPS   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">When set at runtime exposition is set to minimum   </td><td class="markdownTableBodyNone">R/W   </td></tr>
</table>
<p>Internal parameters setted by default: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Code   </th><th class="markdownTableHeadNone">Default   </th><th class="markdownTableHeadNone">Min   </th><th class="markdownTableHeadNone">Max   </th><th class="markdownTableHeadNone">Note   </th><th class="markdownTableHeadNone">R/W    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ext_trigger   </td><td class="markdownTableBodyNone">0x0098cc03   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">0   </td><td class="markdownTableBodyNone">1   </td><td class="markdownTableBodyNone">Need to be set to 1   </td><td class="markdownTableBodyNone">-    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">tag_h   </td><td class="markdownTableBodyNone">0x0098cb02   </td><td class="markdownTableBodyNone">10ms   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">-   </td><td class="markdownTableBodyNone">Dead time between exposures   </td><td class="markdownTableBodyNone">-   </td></tr>
</table>
<p>Only manual parameters are available for now no auto settings. <br  />
 :exclamation: <em>Important note</em>: for not <code>_ABSOLUTE_</code> can only be accepted parameters normalized between 0-1.</p>
<h2><a class="anchor" id="autotoc_md1084"></a>
3.7. How programmatially set YARP-V4L feature</h2>
<p>For a complete example, please reference to the UI project folder: <br  />
 <code><a href="https://github.com/robotology/yarp-device-ultrapython/tree/master/src/ui">https://github.com/robotology/yarp-device-ultrapython/tree/master/src/ui</a></code></p>
<h2><a class="anchor" id="autotoc_md1085"></a>
3.8. FPS (frame per seconds)</h2>
<p>It is possible to specify the desired FPS, however, FPS has a relation with the exposure.</p>
<p><code>Max_Exposure=(1/FPS-8) msec</code></p>
<p>The following table is calculated.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">FPS   </th><th class="markdownTableHeadNone">Max Exposition in msec    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">5   </td><td class="markdownTableBodyNone">0.192    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">10   </td><td class="markdownTableBodyNone">0.100    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">15   </td><td class="markdownTableBodyNone">0.066    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">20   </td><td class="markdownTableBodyNone">0.050    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">25   </td><td class="markdownTableBodyNone">0.040    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">30   </td><td class="markdownTableBodyNone">0.033    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">35   </td><td class="markdownTableBodyNone">0.028    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">40   </td><td class="markdownTableBodyNone">0.025    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">45   </td><td class="markdownTableBodyNone">0.022   </td></tr>
</table>
<p><b>Note</b> that the yarpdev parameter <code>period</code> is used by YARP to sample images from the drive at the given period in msec. Fps can be calculated as <code>1/period</code></p>
<h3><a class="anchor" id="autotoc_md1086"></a>
3.8.1. Avoid FPS oscillations</h3>
<p>Due to the band limits on the TCP, the following hints should be followed. The min <code>period</code> value for UltraPyton, for an uncompressed stream, to avoid FPS oscillations is: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Resolution   </th><th class="markdownTableHeadNone">period   </th><th class="markdownTableHeadNone">FPS    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Low resolution   </td><td class="markdownTableBodyNone">31   </td><td class="markdownTableBodyNone">32.2    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Hi resolution   </td><td class="markdownTableBodyNone">80   </td><td class="markdownTableBodyNone">12.5   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1087"></a>
4. The Ultrapython device</h1>
<p>The UltraPython device is designed to work together with <code>yarpdev</code> and <code>grabberDual</code>.</p>
<h2><a class="anchor" id="autotoc_md1088"></a>
4.1. Device location</h2>
<p>The device is located in the repository <code>yarp-device-ultrapython</code>.</p>
<h2><a class="anchor" id="autotoc_md1089"></a>
4.2. Device architecture</h2>
<p>The software follows the c++17 standard. <br  />
 All the UltraPython camera functionalities are developed inside of the <code>PythonCameraHelper</code> class. The class UltraPythonDrive is for Yarp device infrastructure. Look at the following UML diagram.</p>
<p><img src="img/UML003.png" alt="" width="600px" class="inline"/></p>
<p>A <b>dependency injection technique</b> is used to keep Yarp infrastructure and the UltraPython camera code separate, so test and use of the class in other environment, <em>are easier</em>. <br  />
 <img src="img/UML001.png" alt="" width="400px" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md1090"></a>
4.3. Image buffer memory usage</h2>
<p>The Kernel module allocates a buffer of 4 images that are filled in succession. The current image buffer is passed to UltraPython device through a pointer to the current image. Also, Yarp passes a pointer to a memory area to be filled. The UltraPython device copies the data from Kernel module buffer directly to Yarp memory area in one shoot.</p>
<p><img src="img/UML002.png" alt="" width="400px" class="inline"/></p>
<p>Advantages:</p>
<ul>
<li>Just one memcpy</li>
<li>Just one mutex</li>
<li>Reduced number of buffers in Kernel space</li>
<li>No thread needed in the device</li>
</ul>
<h2><a class="anchor" id="autotoc_md1091"></a>
4.4. Prerequisite before compilation</h2>
<p>All the necessary libraries and applications for SW development should be installed. In addition:</p>
<div class="fragment"><div class="line">sudo apt-get install libudev-dev</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1092"></a>
4.5. How to compile PytonCamera device</h2>
<p>The device can be compiled on x64 or Arm target but it will work only on Arm target. The compilation on x64 is only for unit test purpose.</p>
<div class="fragment"><div class="line">cd ~/icubtech</div>
<div class="line">git clone https://github.com/icub-tech-iit/yarp-device-ultrapython.git</div>
<div class="line">cd ~/icubtech/yarp-device-ultrapython</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">ccmake ..</div>
</div><!-- fragment --><p>Select the install folder that should be the same of yarp</p>
<div class="fragment"><div class="line">CMAKE_INSTALL_PREFIX   &lt;yarp install folder&gt;</div>
</div><!-- fragment --><p>Compile the project:</p>
<div class="fragment"><div class="line">make install</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md1093"></a>
4.6. Compile also the UI</h2>
<p>Install QT:</p>
<div class="fragment"><div class="line">sudo apt-get install qt3d5-dev</div>
</div><!-- fragment --><p>Select from ccmake:</p>
<div class="fragment"><div class="line">COMPILE_WITHUI_ULTRAPYTHON       ON</div>
</div><!-- fragment --><p>And follow the above instructions for compiling.</p>
<h2><a class="anchor" id="autotoc_md1094"></a>
4.7. Code formatting and naming convention</h2>
<p>The code formatting is done using the included <code>.clang-format</code> file. <br  />
 The c++ style follows mainly the <a href="https://google.github.io/styleguide/cppguide.html">https://google.github.io/styleguide/cppguide.html</a> with some notable exceptions.</p>
<h2><a class="anchor" id="autotoc_md1095"></a>
4.8. Unit test</h2>
<p>I have developed unit tests with the <code>gtest</code> and <code>gmock</code> library see <a href="https://google.github.io/googletest/">https://google.github.io/googletest/</a>. The tests can be found in <code>unittest</code> folder.</p>
<p>To activate the unit test check the following in ccmake:</p>
<div class="fragment"><div class="line">COMPILE_WITHUNITTEST_ULTRAPYTHON   ON</div>
</div><!-- fragment --><p>The unit test takes advantage of the use of class <code><a class="el" href="classInterfaceForCApi.html">InterfaceForCApi</a></code> this class wrap low-level C API to C++ API. Also the unit test mock, with the <code>gmock</code> library, the low level working. This makes it possible to create tests without using low-level SW.</p>
<p><img src="img/UML004.png" alt="" width="400px" class="inline"/></p>
<p>Unit tests were created also for the command-line tool. In this case, The <code>gmock</code> library is used to mock the <code>get</code> and <code>set</code> of the camera features.</p>
<p><img src="img/UML005.png" alt="" width="350px" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md1096"></a>
4.9. Development environment</h2>
<p>To develop the software on the Enclustra board is necessary to setup a remote development environment, as Enclustra can't be used with a UI. <br  />
 We have decided to use vscode with ssh extension.</p>
<p>:exclamation:<u>To be done on iCub-head with running Enclustra.</u></p>
<p>Download and install vscode:https://code.visualstudio.com/ <br  />
 Install plugin for vscode named:</p>
<ul>
<li><code>ms-vscode-remote.remote-ssh</code></li>
<li><code>ms-vscode-remote.remote-ssh-edit</code></li>
<li><code>xaver.clang-format</code></li>
</ul>
<p>Edit file ~/.ssh/config, add at the end:</p>
<div class="fragment"><div class="line">Host Enclustra</div>
<div class="line">  HostName 10.0.1.233</div>
<div class="line">  User root</div>
<div class="line">  ForwardAgent yes</div>
</div><!-- fragment --><p>Connect using the correct host among your list (<code>Connect to Host in surrent windows</code>):</p>
<p><img src="img/dev001.png" alt="" width="500px" class="inline"/></p>
<p>then you can open the remote folder on the same windows:</p>
<p><img src="img/dev002.png" alt="" width="500px" class="inline"/></p>
<p>Choose the remote folder <code>/root/icubtech/yarp/src/devices/usbCamera/linux</code></p>
<p>A remote terminal is also available from the <code>Terminal</code> menu.</p>
<p>:warning:<em>Troubleshooting</em></p>
<ol type="1">
<li>If vscode won't connect try to check the Enclustra file system. <code>fsck / -y</code> Then restart boot Enclustra and vscode.</li>
<li>If vscode still won't connect try to delete, on Enclustra, the following files:</li>
</ol>
<div class="fragment"><div class="line">rm /root/.vscode-server/.*</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md1097"></a>
5. Using UltraPython with a prebuild Docker</h1>
<p>Docker instructions</p>
<h1><a class="anchor" id="autotoc_md1098"></a>
6. Testing the video stream</h1>
<p>For testing the stream look at <a class="el" href="md_opt-modules_2yarp-device-ultrapython_2TESTING.html">testing</a>.</p>
<h1><a class="anchor" id="autotoc_md1099"></a>
7. Useful</h1>
<p>For useful look at <a class="el" href="md_opt-modules_2yarp-device-ultrapython_2USEFUL.html">useful</a>.</p>
<h1><a class="anchor" id="autotoc_md1100"></a>
8. Ubuntu SD card creation for Enclustra</h1>
<p>For SD-card setup look at <a class="el" href="md_opt-modules_2yarp-device-ultrapython_2SDSETUP.html">SD-card creation</a>.</p>
<h1><a class="anchor" id="autotoc_md1101"></a>
9. OBSOLETE</h1>
<p>For obsolete procedures look at <a class="el" href="md_opt-modules_2yarp-device-ultrapython_2OBSOLETE.html">obsolete</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li><span id="projectname_footer">YARP</span></li>
    <li><span id="projectnumber" class="version_switch">3.8.1</span></li>
    <li class="footer">Generated on Wed Sep 13 2023 08:44:47 for YARP by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
